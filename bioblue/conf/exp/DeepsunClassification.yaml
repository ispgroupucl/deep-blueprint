# @package _global_
defaults:
  - override /module: base_classification


trainer:
  _target_: pytorch_lightning.Trainer
  max_epochs: 30
  gpus: ${gpus}
  auto_scale_batch_size: false
  log_every_n_steps: 2

# logger: []
logger:
  - _target_: pytorch_lightning.loggers.CSVLogger
    save_dir: 'csv_metrics'
  # - _target_: pytorch_lightning.loggers.WandbLogger
  #   # name: 'test'
  #   project: 'Deepsun_classification'
  #   save_dir: "."

use_dtypes: "???"

use_classes: [ 'A','B','C','D','E','F','G','H','I','J','X']

module:
  _target_: bioblue.module.BaseClassifier
  classifier: "${model}"
  lr: 1e-4
  optimizer: torch.optim.AdamW
  # ######## WORKS
  loss:
    _target_: torch.nn.CrossEntropyLoss
  class_weights: [1,1,1,1,1,1,1,1,1,1,1]
  # class_weights: [8,7,5,5,22,170,41,13,100,5,100]
  

  scheduler:
    _target_: torch.optim.lr_scheduler.MultiStepLR
    milestones: [10, 30, 50]
    gamma: 0.1

  # scheduler:
  #   _target_: torch.optim.lr_scheduler.StepLR
  #   step_size: 250
  #   gamma: 0.9
  #   last_epoch: -1

model:
  # _target_: bioblue.model.ResNetClassifierV2
  # _target_: bioblue.model.ResNetClassifierV4
  _target_: bioblue.model.MobileNetClassifier
  
  # input_format: ["image"]
  input_format: ["image", "angular_excentricity", "centroid_Lat" ]
  output_format: ["class"]

  classes: ${use_classes}

  architecture:
    mobilenet_version: 'v2'
    pretrained: false


  # architecture:
  #   resnet_version: '18'
  #   pretrained: true
  #   tune_fc_only: false
  #   fcn_width: 500
  #   fcn_num_hidden: 3


  # architecture:
  #   resnet_version: '50'
  #   pretrained: true
  #   tune_fc_only: false
  


  # _target_: bioblue.model.ConfUnet
  # model_cfg:
  #   _target_: bioblue.model.ModelConfig
  # block: double


# model:
#   _target_: bioblue.model.ConfResNet
  
#   # input_format: ["image"]
#   input_format: ["image", "angular_excentricity", "centroid_Lat" ]
#   output_format: ["class"]

#   classes: ${use_classes}
  
#   model_cfg:
#     _target_: bioblue.model.ModelConfig
#   architecture:
#     first: 32
#     block_width: [32, 64, 128] 
#     num_resnet_blocks: [6,6,6]
#     cnn_input_size: ${dataset.train_dataset.transforms.0.standard_height}
#     fcn_width: 500
#     fcn_num_hidden: 3

#   # _target_: bioblue.model.ConfUnet
#   # model_cfg:
#   #   _target_: bioblue.model.ModelConfig
#   # block: double
  

dataset:
  _target_: bioblue.dataset.BioblueDataModule
  data_dir: "/home/sayez/Deepsun/Classification_dataset/"
  # data_dir: "/globalscratch/users/n/s/nsayez/Classification_dataset/"
  dataset_name: "2002-2019"
  batch_size: 16
  num_workers: 12
  
  train_dataset:
    _target_: bioblue.dataset.DeepsunMaskedClassificationDatasetV2
    partition: "train"
    dtypes: ${use_dtypes}
    classes: ${use_classes}
    transforms:
      - _target_: bioblue.transforms.DeepsunRotateAndCropAroundGroup
        standard_height: 128
        standard_width: 128
      - _target_: bioblue.transforms.DeepsunClassificationRandomFlip
      # - _target_: bioblue.transforms.DeepsunClassificationRandomRotate
      - _target_: bioblue.transforms.DeepsunImageAndScalars2ThreeChannels
      # - _target_: bioblue.transforms.DeepsunImageMaskProduct
  

  val_dataset:
    _target_: bioblue.dataset.DeepsunMaskedClassificationDatasetV2
    partition: "val"
    dtypes: ${use_dtypes}
    classes: ${use_classes}
    transforms:
      - _target_: bioblue.transforms.DeepsunRotateAndCropAroundGroup
        standard_height: 128
        standard_width: 128
      - _target_: bioblue.transforms.DeepsunClassificationRandomFlip
      # - _target_: bioblue.transforms.DeepsunClassificationRandomRotate
      - _target_: bioblue.transforms.DeepsunImageAndScalars2ThreeChannels
      # - _target_: bioblue.transforms.DeepsunImageMaskProduct
   
  test_dataset:     
    _target_: bioblue.dataset.DeepsunMaskedClassificationDatasetV2
    partition: "test"
    dtypes: ${use_dtypes}
    classes: ${use_classes}
    transforms:
      - _target_: bioblue.transforms.DeepsunRotateAndCropAroundGroup
        standard_height: 128
        standard_width: 128
      - _target_: bioblue.transforms.DeepsunClassificationRandomFlip
      # - _target_: bioblue.transforms.DeepsunClassificationRandomRotate
      - _target_: bioblue.transforms.DeepsunImageAndScalars2ThreeChannels
      # - _target_: bioblue.transforms.DeepsunImageMaskProduct

callbacks:
  # wandb:
  #   _target_: bioblue.callback.WandBCallback
  #   log_models: false
  model_checkpoint:
    _target_: pytorch_lightning.callbacks.ModelCheckpoint
    dirpath: "./models"
    save_last: true
    monitor: val_acc
    mode: max
    filename: "{epoch}-{val_meaniou:.2f}"
  LR_monitor:
    _target_: "pytorch_lightning.callbacks.LearningRateMonitor"
